# AI Assistant Configuration - Quick Reference

This file serves as a bridge between different AI coding assistants (VS Code Copilot, Antigravity, etc.)

## Quick Start Commands

### Testing

```bash
make test          # Run full test suite
make dev          # Install development dependencies
```

### Common Tasks

#### 1. Adding a New Variable Type

- Update `src/parsers/type_mapper.py` with the new type
- Add parser logic in `src/parsers/workers/gem5_parse_work.py`
- Create tests in `tests/unit/test_data_parser_perl.py`

#### 2. Adding a New Plot Type

- Create class in `src/plotting/types/`
- Register in `src/plotting/plot_factory.py`
- Add UI config in `src/web/ui/components/plot_manager_components.py`

#### 3. Adding a New Shaper

- Create class in `src/web/services/shapers/`
- Register in `src/web/services/shapers/factory.py`
- Add tests in `tests/unit/test_selectors.py` or `test_shapers_extended.py`

#### 4. Parsing Workflow

```python
# 1. Scan for variables
scan_futures = facade.submit_scan_async(path, pattern, limit=10)
scan_results = [f.result() for f in scan_futures]
variables = facade.finalize_scan(scan_results)

# 2. Parse with discovered variables
parse_futures = facade.submit_parse_async(
    path, pattern, selected_vars, output_dir, scanned_vars=variables
)
parse_results = [f.result() for f in parse_futures]
csv_path = facade.finalize_parsing(output_dir, parse_results)

# 3. Load and process
data = facade.load_csv_file(csv_path)
processed = facade.apply_shapers(data, shaper_pipeline)
```

## Architecture Layers

```
┌─────────────────────────────────────────┐
│  Layer C: Presentation (Streamlit UI)  │
│  - pages/, ui/components/               │
│  - Uses: st.*, PlotFactory              │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  Layer B: Domain Logic (Business)      │
│  - plotting/, services/, shapers/       │
│  - NO UI dependencies                   │
└─────────────────┬───────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│  Layer A: Data Layer (Parsing)         │
│  - parsers/, workers/, perl/            │
│  - Async operations, file I/O          │
└─────────────────────────────────────────┘
```

## DO

- ✅ Use async API: `submit_*_async()` → `finalize_*()`
- ✅ **Use STRONG TYPING on ALL functions/methods/classes**
- ✅ Run `mypy --strict` before committing
- ✅ Copy DataFrames: `result = data.copy()`
- ✅ Write tests BEFORE implementation (TDD)
- ✅ Use specific exceptions: `except ValueError:`
- ✅ Use `TypedDict` for structured dicts, `Protocol` for interfaces
- ✅ Prefer `List[str]` over `list`, `Dict[str, int]` over `dict`

## DON'T

- ❌ **NEVER execute git commands** (FORBIDDEN)
- ❌ **Never skip type hints** - all functions must be typed
- ❌ Never use `Any` without documentation
- ❌ Never create sync wrappers around async API
- ❌ Never use `inplace=True` on DataFrames
- ❌ Never mix UI code with business logic
- ❌ Never use bare `except:`

## Quick Patterns

### Strong Typing Example

```python
from typing import List, Dict, Optional, TypedDict
import pandas as pd
from pathlib import Path

class ParseConfig(TypedDict):
    pattern: str
    output_dir: str
    limit: Optional[int]

def parse_stats(
    stats_path: Path,
    config: ParseConfig
) -> Optional[pd.DataFrame]:
    """
    Parse gem5 stats file.

    Args:
        stats_path: Path to stats.txt
        config: Parse configuration

    Returns:
        DataFrame with results or None if failed
    """
    result: Optional[pd.DataFrame] = None
    # ...
    return result
```

### Async Workflow

│ - services/, plotting/ │
│ - NO UI dependencies │
│ - Shapers, reducers, aggregators │
└─────────────────┬───────────────────────┘
│
▼
┌─────────────────────────────────────────┐
│ Layer A: Data Ingestion (Parsing) │
│ - parsers/, type_mapper │
│ - Async workers, pool management │
└─────────────────────────────────────────┘

````

## Critical Patterns

### ✅ DO
- Use async API: `submit_*_async()` → wait → `finalize_*()`
- Return new DataFrames (immutable)
- Type hint everything
- Write tests before implementing
- Use factories for plot/shaper creation
- Handle specific exceptions

### ❌ DON'T
- Create synchronous wrapper methods
- Use `inplace=True` on DataFrames
- Mix UI code with domain logic
- Skip tests
- Use bare `except:` blocks
- Guess values when parsing fails

## State Management (Streamlit)

```python
# Access state
from src.web.state_manager import StateManager

data = StateManager.get_data()
config = StateManager.get_config()
variables = StateManager.get_parse_variables()

# Update state (triggers rerun)
StateManager.set_data(new_data)
StateManager.set_parse_variables(vars)
````

## Key Files

- **Entry Point**: `app.py` (Streamlit app)
- **Backend API**: `src/web/facade.py` (BackendFacade)
- **Async Services**:
  - `src/parsers/parse_service.py`
  - `src/parsers/scanner_service.py`
- **Work Pools**: `src/parsers/workers/pool.py`
- **Type System**: `src/parsers/type_mapper.py`
- **Plot Factory**: `src/plotting/plot_factory.py`
- **Shaper Factory**: `src/web/services/shapers/factory.py`

## Debugging Tips

1. **Parser Issues**: Check `tests/integration/test_gem5_parsing.py` for examples
2. **UI State**: Use `st.write(st.session_state)` to inspect
3. **Async Issues**: Add logging in worker classes
4. **Test Failures**: Run specific test with `./python_venv/bin/pytest tests/path/to/test.py -v`

## Configuration Files

- `.agent/rules/project-context.md` - Full rules (Antigravity)
- `.github/copilot-instructions.md` - VS Code Copilot instructions
- `pyproject.toml` - Python project config
- `.vscode/settings.json` - VS Code settings

## External References

- gem5 Documentation: https://www.gem5.org/documentation/
- Plotly Graph Objects: https://plotly.com/python/graph-objects/
- Streamlit API: https://docs.streamlit.io/
